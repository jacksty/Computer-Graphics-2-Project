<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf8>
        <script src='../tdl.js'></script>
<script>
    
tdl.test={

numfailed: 0,
numpassed: 0,
numtests: 0,
remaining: [],

alltests: ["filetest","filetest2","filetest3","filetest4","texturetest","instancetest"],

currenttest: undefined, 

run_next_test: function(){
    var alltests = tdl.test.alltests;
    
    if( document.location.search ){
        var tmp = document.location.search+"";
        tmp = tmp.substring(1);
        tmp = tmp.split("&");
        
        for(var i=0;i<alltests.length;++i){
            var flag=false;
            for(var j=0;j<tmp.length;++j){
                if( alltests[i] === tmp[j] ){
                    flag=true;
                    break;
                }
            }
            if( flag === false ){
                alltests.splice(i,1);
                i--;
            }
        }
    }
    
    if( tdl.test.alltests.length === 0 )
        tdl.test.done();
    else{
        var testname = tdl.test.alltests.shift();
        tdl.test.currenttest = testname;
        console.log("========Running test "+testname+"=========");
        var scriptname = testname + ".js";
        var sc = document.createElement("script");
        sc.src = scriptname;
        document.head.appendChild(sc);
    }
},

pass: function(){
    tdl.test.numpassed += 1;
    console.log(tdl.test.currenttest,"passed");
    while( document.body.childNodes.length > 0 ){
        document.body.removeChild(document.body.childNodes[0]);
    }
    tdl.test.run_next_test();
},

fail: function(){
    tdl.test.numfailed++;
    console.error(tdl.test.currenttest,"failed");
},


    
done: function(){
    console.log("Done: Passed: "+tdl.test.numpassed+
        " Failed: "+tdl.test.numfailed);
},

test: function(){
    return;
    
    var token = "test"+tdl.test.numtests+"-"+descr;
    tdl.test.numtests++;
    tdl.test.remaining.push(token);
    return token;
},

compareImages: function(gl, img){
    
    var L = new tdl.Loader(function(){})
    L.loadDataURL(img,function(data){ 
        
        var width = gl.canvas.width;
        var height = gl.canvas.height;
        
        var cvs = document.createElement("canvas");
        cvs.width=width;
        cvs.height=height;
        document.body.appendChild(cvs);
        var ctx = cvs.getContext("2d");
        var img = new Image();
        img.src = data;
        ctx.drawImage(img,0,0);
        var cvspix = ctx.getImageData(0,0,width,height);
        
        
        glpix = new Uint8Array(width*height*4);
        gl.readPixels(0,0,width,height,gl.RGBA,gl.UNSIGNED_BYTE,glpix);

        var np = img.width*img.height;
        for(var y=0;y<img.height;++y){
            var gi = y*img.width*4;
            var ci = (height-y-1)*img.width*4;
            for(var x=0;x<img.width;++x){
                var gred = glpix[gi++];
                var cred = cvspix.data[ci++];
                var ggreen = glpix[gi++];
                var cgreen = cvspix.data[ci++];
                var gblue = glpix[gi++];
                var cblue = cvspix.data[ci++];
                var galpha = glpix[gi++];
                var calpha = cvspix.data[ci++];
            
                if( gred !== cred  || ggreen !== cgreen || gblue !== cblue || galpha !== calpha ){
                    console.log(gred,ggreen,gblue,galpha);
                    console.log(cred,cgreen,cblue,calpha);
                    tdl.test.fail();
                    return
                }
            }
        }
        tdl.test.pass();
        L.finish();
    });
}

};
</script>
</head>
<body>
</body>

<script>
tdl.test.run_next_test();
</script>

</html>
